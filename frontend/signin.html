<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost&Found - Sign In</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="register.css">
    <link rel="stylesheet" href="global.css">
</head>
<body>
    <div class="container-fluid d-flex flex-column flex-md-row min-vh-100 p-0 custom-gradient-bg">
        <div class="col-12 col-md-7 d-flex flex-column justify-content-between p-4 p-md-5 text-white custom-left-section">
            <h1 class="fw-bold mb-4 custom-brand-logo">Lost<a style="color: #2F455C;">&</a>Found</h1>
            <div class="mb-auto mt-auto text-center text-md-start">
                <h2 class="fw-bold custom-slogan">Lost it? Found it?<br>
                    Let's get it back<br>
                    to the right hands.</h2>
            </div>
            <div class="d-none d-md-block" style="height: 50px;"></div>
        </div>

        <div class="col-12 col-md-5 d-flex align-items-center justify-content-center p-4 p-md-5 custom-right-section">
            <div class="card p-4 p-md-5 custom-card">
                <h2 class="fw-bold mb-4 text-center text-md-start">Sign In</h2>
                <form>
                    <div class="mb-3">
                        <label for="emailInput" class="form-label">Email</label>
                        <input type="email" class="form-control custom-form-control" id="emailInput" placeholder="xxxxxx@kmitl.ac.th">
                    </div>
                    <div class="mb-3">
                        <label for="passwordInput" class="form-label">Password</label>
                        <input type="password" class="form-control custom-form-control" id="passwordInput" placeholder="your password">
                    </div>
                    <div class="d-flex justify-content-end mb-4">
                        <a href="signup.html" class="text-decoration-none custom-link-text">Create new account</a>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 custom-login-btn">Login</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.querySelector('form');
        
        // Phone number validation function (for potential future use)
        function validatePhoneNumber(phone) {
            const cleanPhone = phone.replace(/\s/g, '');
            const phoneRegex = /^0\d{9}$/;
            return phoneRegex.test(cleanPhone);
        }

        // Format phone number as user types (0XX XXX XXXX)
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length > 0 && value[0] !== '0') {
                value = '0' + value;
            }
            
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            if (value.length > 3 && value.length <= 6) {
                value = value.replace(/(\d{3})(\d{0,3})/, '$1 $2');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1 $2 $3');
            }
            
            input.value = value;
        }

        // Prevent non-numeric input for phone fields
        function preventNonNumericInput(inputElement) {
            inputElement.addEventListener('keydown', function(e) {
                if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) || 
                    (e.keyCode === 65 && e.ctrlKey === true) || 
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        }

        // Add phone formatting and validation to any phone input on page
        const phoneInputs = document.querySelectorAll('input[type="tel"]');
        phoneInputs.forEach(input => {
            input.addEventListener('input', function() {
                formatPhoneNumber(this);
                
                const phone = this.value.trim();
                if (phone && !validatePhoneNumber(phone)) {
                    this.style.borderColor = 'red';
                    if (!document.getElementById('phoneHint')) {
                        const hint = document.createElement('small');
                        hint.id = 'phoneHint';
                        hint.className = 'text-danger mt-1';
                        hint.textContent = 'Phone must start with 0 and have 10 digits (0XX XXX XXXX)';
                        this.parentNode.appendChild(hint);
                    }
                } else {
                    this.style.borderColor = '';
                    const hint = document.getElementById('phoneHint');
                    if (hint) hint.remove();
                }
            });

            preventNonNumericInput(input);
        });
        
        // Check if user is already logged in
        const userData = localStorage.getItem('user');
        if (userData) {
            // Redirect to home page if already logged in
            window.location.href = 'index.html';
            return;
        }
        
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            // Validate form
            if (!email) {
                alert('Please enter your email.');
                document.getElementById('emailInput').focus();
                return;
            }
            
            // KMITL email validation
            const emailRegex = /^[^\s@]+@kmitl\.ac\.th$/;
            if (!emailRegex.test(email)) {
                alert('Please use a valid KMITL email address (xxxxxxx@kmitl.ac.th).');
                document.getElementById('emailInput').focus();
                return;
            }
            
            if (!password) {
                alert('Please enter your password.');
                document.getElementById('passwordInput').focus();
                return;
            }
            
            const formData = {
                email: email,
                password: password
            };

            try {
                const response = await fetch('http://localhost:8000/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Store user data in localStorage
                    localStorage.setItem('user', JSON.stringify(result.user_data));
                    localStorage.setItem('isLoggedIn', 'true');
                    
                    alert('Login successful! Welcome ' + result.user_data.name);
                    // Redirect to home page
                    window.location.href = 'index.html';
                } else {
                    alert('Error: ' + (result.detail || 'Invalid email or password'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Login failed. Please check if backend is running.');
            }
        });
        
        // Real-time KMITL email validation
        document.getElementById('emailInput').addEventListener('blur', function() {
            const email = this.value.trim();
            const emailRegex = /^[^\s@]+@kmitl\.ac\.th$/;
            
            if (email && !emailRegex.test(email)) {
                this.style.borderColor = 'red';
                // Show hint text
                if (!document.getElementById('emailHint')) {
                    const hint = document.createElement('small');
                    hint.id = 'emailHint';
                    hint.className = 'text-danger mt-1';
                    hint.textContent = 'KMITL email required (@kmitl.ac.th)';
                    this.parentNode.appendChild(hint);
                }
            } else {
                this.style.borderColor = '';
                const hint = document.getElementById('emailHint');
                if (hint) hint.remove();
            }
        });

        // Add input validation styling for password
        document.getElementById('passwordInput').addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.style.borderColor = 'red';
            } else {
                this.style.borderColor = '';
            }
        });

        // Add input validation styling for email on input
        document.getElementById('emailInput').addEventListener('input', function() {
            const email = this.value.trim();
            const emailRegex = /^[^\s@]+@kmitl\.ac\.th$/;
            
            if (email && !emailRegex.test(email)) {
                this.style.borderColor = 'red';
            } else {
                this.style.borderColor = '';
            }
        });
    });
    </script>
</body>
</html>