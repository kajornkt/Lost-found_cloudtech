<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost&Found - Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="register.css">
    <link rel="stylesheet" href="global.css">
</head>
<body>
    <div class="container-fluid d-flex flex-column flex-md-row min-vh-100 p-0 custom-gradient-bg">
        
        <div class="col-12 col-md-7 d-flex flex-column justify-content-between p-4 p-md-5 text-white custom-left-section">
            <h1 class="fw-bold mb-4 custom-brand-logo">Lost<a style="color: #2F455C;">&</a>Found</h1>
            <div class="mb-auto mt-auto text-center text-md-start">
                <h2 class="fw-bold custom-slogan">Lost it? Found it?<br>
                    Let's get it back<br>
                    to the right hands.</h2>
            </div>
            <div class="d-none d-md-block" style="height: 50px;"></div>
        </div>

        <div class="col-12 col-md-5 d-flex align-items-center justify-content-center p-4 p-md-5 custom-right-section">
            <div class="card p-4 p-md-5 custom-card">
                <h2 class="fw-bold mb-4 text-center text-md-start">Sign up</h2>
                <form>
                    <div class="mb-3">
                        <label for="nameInput" class="form-label">Name</label>
                        <input type="text" class="form-control custom-form-control" id="nameInput" placeholder="Name Surname">
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="facultySelect" class="form-label">Faculty</label>
                            <div class="select-wrapper">
                                <select class="form-select custom-form-control" id="facultySelect">
                                    <option selected>select</option>
                                    <option value="1">School of Engineering</option>
                                    <option value="2">School of Architecture, Art, and Design</option>
                                    <option value="3">School of Industrial Education and Technology</option>
                                    <option value="4">School of Agricultural Technology</option>
                                    <option value="5">School of Science</option>
                                    <option value="6">School of Food Industry</option>
                                    <option value="7">School of Information Technology</option>
                                    <option value="8">International College</option>
                                    <option value="9">College of Materials Innovation and Technology</option>
                                    <option value="10">College of Advanced Manufacturing Innovation</option>
                                    <option value="11">KMITL Business School</option>
                                    <option value="12">International Academy of Aviation Industry</option>
                                    <option value="13">School of Liberal Arts</option>
                                    <option value="14">Faculty of Medicine</option>
                                    <option value="15">College of Innovation and Industrial Management</option>
                                    <option value="16">Institute of Music Science and Engineering</option>
                                    <option value="17">School of Dentistry</option>
                                    <option value="18">School of Nursing Science</option>
                                    <option value="19">School of Integrated Innovative Technology</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <label for="classYearInput" class="form-label">Class year</label>
                            <input type="text" class="form-control custom-form-control" id="classYearInput" placeholder="year number">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="phoneInput" class="form-label">Phone</label>
                        <input type="tel" class="form-control custom-form-control" id="phoneInput" placeholder="0XX XXX XXXX">
                    </div>

                    <div class="mb-3">
                        <label for="emailInput" class="form-label">Email</label>
                        <input type="email" class="form-control custom-form-control" id="emailInput" placeholder="xxxxxx@kmitl.ac.th">
                    </div>
                    
                    <div class="mb-3">
                        <label for="passwordInput" class="form-label">Password</label>
                        <input type="password" class="form-control custom-form-control" id="passwordInput" placeholder="your password">
                    </div>

                    <div class="mb-3">
                        <label for="confirmPasswordInput" class="form-label">Confirm password</label>
                        <input type="password" class="form-control custom-form-control" id="confirmPasswordInput" placeholder="confirm your password">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Social accounts</label>
                        <div id="social-links-container">
                            </div>
                        <button type="button" class="btn w-100 mt-2 custom-add-social-btn" id="addSocialLinkBtn">
                            <i class="fas fa-plus"></i> Add more social link
                        </button>
                    </div>

                    <div class="d-flex justify-content-end mb-3">
                        <span class="text-muted me-1">Already have an account?</span>
                        <a href="signin.html" class="text-decoration-none custom-link-text custom-sign-in-link">sign in</a>
                    </div>
                    
                    <button type="submit" class="btn w-100 custom-create-account-btn">
                        Create new account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const addSocialLinkBtn = document.getElementById('addSocialLinkBtn');
        const socialLinksContainer = document.getElementById('social-links-container');
        const profileForm = document.querySelector('form');

        // Phone number validation function
        function validatePhoneNumber(phone) {
            // Remove any spaces for validation
            const cleanPhone = phone.replace(/\s/g, '');
            
            // Check if it starts with 0 and has exactly 10 digits
            const phoneRegex = /^0\d{9}$/;
            return phoneRegex.test(cleanPhone);
        }

        // Format phone number as user types (0XX XXX XXXX)
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            
            // Ensure it starts with 0
            if (value.length > 0 && value[0] !== '0') {
                value = '0' + value;
            }
            
            // Limit to 10 digits
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            // Format as 0XX XXX XXXX
            if (value.length > 3 && value.length <= 6) {
                value = value.replace(/(\d{3})(\d{0,3})/, '$1 $2');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1 $2 $3');
            }
            
            input.value = value;
        }

        // Add real-time phone number formatting and validation
        document.getElementById('phoneInput').addEventListener('input', function() {
            formatPhoneNumber(this);
            
            // Real-time validation styling
            const phone = this.value.trim();
            if (phone && !validatePhoneNumber(phone)) {
                this.style.borderColor = 'red';
                // Show hint text
                if (!document.getElementById('phoneHint')) {
                    const hint = document.createElement('small');
                    hint.id = 'phoneHint';
                    hint.className = 'text-danger mt-1';
                    hint.textContent = 'Phone must start with 0 and have 10 digits (0XX XXX XXXX)';
                    this.parentNode.appendChild(hint);
                }
            } else {
                this.style.borderColor = '';
                const hint = document.getElementById('phoneHint');
                if (hint) hint.remove();
            }
        });

        // Prevent non-numeric input (except spaces which we handle in formatting)
        document.getElementById('phoneInput').addEventListener('keydown', function(e) {
            // Allow: backspace, delete, tab, escape, enter, arrows
            if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) || 
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) || 
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Allow: home, end, left, right
                (e.keyCode >= 35 && e.keyCode <= 39)) {
                return;
            }
            
            // Ensure that it is a number and stop the keypress if not
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });

        // Add social link functionality
        addSocialLinkBtn.addEventListener('click', () => {
            if (socialLinksContainer.childElementCount < 5) {
                createSocialLinkGroup(true);
            } else {
                alert('You can add a maximum of 5 social links.');
                addSocialLinkBtn.disabled = true;
            }
        });
        
        // FORM SUBMISSION - CONNECTS TO PYTHON BACKEND
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form before submission
            if (!validateForm()) {
                return;
            }
            
            // Collect form data
            const formData = {
                full_name: document.getElementById('nameInput').value.trim(),
                faculty: document.getElementById('facultySelect').value,
                class_year: document.getElementById('classYearInput').value.trim(),
                phone: document.getElementById('phoneInput').value.trim(),
                email: document.getElementById('emailInput').value.trim(),
                password: document.getElementById('passwordInput').value,
                confirm_password: document.getElementById('confirmPasswordInput').value,
                social_profiles: Array.from(socialLinksContainer.querySelectorAll('.social-link-group')).map(group => {
                    const platform = group.querySelector('select').value;
                    const profile_url = group.querySelector('input').value.trim();
                    return { platform, profile_url };
                }).filter(link => link.profile_url !== '') // Remove empty links
            };

            // Validate social links
            if (formData.social_profiles.length === 0) {
                alert('Please add at least one social media link.');
                return;
            }

            // Send to Python backend
            try {
                const response = await fetch('http://localhost:8000/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('Account created successfully!');
                    window.location.href = 'signin.html';
                } else {
                    alert('Error: ' + (result.detail || 'Registration failed'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create account. Please check if backend is running.');
            }
        });

        // Form validation function
        function validateForm() {
            const name = document.getElementById('nameInput').value.trim();
            const faculty = document.getElementById('facultySelect').value;
            const classYear = document.getElementById('classYearInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            // Check if all fields are filled
            if (!name) {
                alert('Please enter your name.');
                document.getElementById('nameInput').focus();
                return false;
            }

            if (faculty === 'select') {
                alert('Please select your faculty.');
                document.getElementById('facultySelect').focus();
                return false;
            }

            if (!classYear) {
                alert('Please enter your class year.');
                document.getElementById('classYearInput').focus();
                return false;
            }

            // Phone validation
            if (!phone) {
                alert('Please enter your phone number.');
                document.getElementById('phoneInput').focus();
                return false;
            }
            
            if (!validatePhoneNumber(phone)) {
                alert('Please enter a valid phone number starting with 0 and containing exactly 10 digits (0XX XXX XXXX).');
                document.getElementById('phoneInput').focus();
                return false;
            }

            if (!email) {
                alert('Please enter your email.');
                document.getElementById('emailInput').focus();
                return false;
            }

            // Email validation - KMITL domain only
            const emailRegex = /^[^\s@]+@kmitl\.ac\.th$/;
            if (!emailRegex.test(email)) {
                alert('Please use a valid KMITL email address (xxxxxxx@kmitl.ac.th).');
                document.getElementById('emailInput').focus();
                return false;
            }

            if (!password) {
                alert('Please enter a password.');
                document.getElementById('passwordInput').focus();
                return false;
            }

            // Password length validation
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                document.getElementById('passwordInput').focus();
                return false;
            }

            if (!confirmPassword) {
                alert('Please confirm your password.');
                document.getElementById('confirmPasswordInput').focus();
                return false;
            }

            // Password match validation
            if (password !== confirmPassword) {
                alert('Password and confirm password do not match!');
                document.getElementById('confirmPasswordInput').focus();
                return false;
            }

            return true;
        }

        // Real-time email validation
        document.getElementById('emailInput').addEventListener('blur', function() {
            const email = this.value.trim();
            const emailRegex = /^[^\s@]+@kmitl\.ac\.th$/;
            
            if (email && !emailRegex.test(email)) {
                this.style.borderColor = 'red';
                // Show hint text
                if (!document.getElementById('emailHint')) {
                    const hint = document.createElement('small');
                    hint.id = 'emailHint';
                    hint.className = 'text-danger mt-1';
                    hint.textContent = 'Please use @kmitl.ac.th email only';
                    this.parentNode.appendChild(hint);
                }
            } else {
                this.style.borderColor = '';
                const hint = document.getElementById('emailHint');
                if (hint) hint.remove();
            }
        });

        // Real-time password match validation
        document.getElementById('confirmPasswordInput').addEventListener('input', function() {
            const password = document.getElementById('passwordInput').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.style.borderColor = 'red';
            } else {
                this.style.borderColor = '';
            }
        });

        // Social link functions
        function createSocialLinkGroup(removable = true) {
            const div = document.createElement('div');
            div.className = 'social-link-group d-flex align-items-start mb-3';
            
            div.innerHTML = `
                <div style="width: 150px; flex-shrink: 0;" class="me-2">
                    <select class="form-select custom-form-control" required>
                        <option value="">Select Platform</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Instagram">Instagram</option>
                        <option value="LINE">LINE</option>
                        <option value="Twitter">Twitter / X</option>
                        <option value="Discord">Discord</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <input type="text" class="form-control custom-form-control" placeholder="Enter profile link" required>
                ${removable ? '<button type="button" class="btn btn-sm btn-danger ms-2" style="flex-shrink: 0; height: 44px; line-height: 1;">&times;</button>' : ''}
            `;
            
            socialLinksContainer.appendChild(div);

            if (removable) {
                const removeButton = div.querySelector('.btn-danger');
                removeButton.addEventListener('click', function() {
                    this.closest('.social-link-group').remove();
                    if (socialLinksContainer.childElementCount < 5) {
                        addSocialLinkBtn.disabled = false;
                    }
                });
            }

            // Add validation to new inputs
            const select = div.querySelector('select');
            const input = div.querySelector('input');
            
            select.addEventListener('change', validateSocialLinks);
            input.addEventListener('input', validateSocialLinks);
        }
        
        function validateSocialLinks() {
            const socialLinks = Array.from(socialLinksContainer.querySelectorAll('.social-link-group'));
            const hasValidLink = socialLinks.some(group => {
                const platform = group.querySelector('select').value;
                const link = group.querySelector('input').value.trim();
                return platform && link;
            });
            
            return hasValidLink;
        }
        
        function resetSocialLinks() {
            socialLinksContainer.innerHTML = '';
            createSocialLinkGroup(false);
        }

        // Initialize with one social link
        resetSocialLinks();
    });
    </script>
</body>
</html>